# Система уведомлений ФМС

## Описание проекта

Система уведомлений ФМС - это веб-приложение для создания, управления и обработки миграционных документов. Система позволяет пользователям создавать уведомления о прибытии иностранных граждан, управлять документами, генерировать PDF-файлы и обеспечивает безопасную аутентификацию пользователей.

## Основные возможности

- **Аутентификация и авторизация** с использованием JWT токенов
- **Создание и редактирование** миграционных документов
- **Генерация PDF** документов на основе заполненных форм
- **Управление документами** (просмотр, редактирование, удаление)
- **Безопасное хранение** данных с использованием MongoDB и Redis
- **CSRF защита** и безопасные сессии

## Архитектура

Приложение построено на FastAPI с использованием:
- **MongoDB** - основное хранилище данных
- **Redis** - кеширование и управление сессиями
- **Jinja2** - шаблонизация HTML страниц
- **JWT** - аутентификация пользователей

## Структура проекта

```
web_app/
├── src/
│   ├── core/          # Конфигурация и настройки
│   ├── crud/          # Операции с базой данных
│   ├── dependencies/  # Зависимости
│   ├── middleware/    # middleware
│   ├── models/        # Pydantic модели
│   ├── schemas/       # Схемы данных
│   ├── static/        # Статические файлы (CSS, JS, xlsx, pdf)
│   └── utils/        # Вспомогательные утилиты  
│   main.py        # Точка входа
├── templates/         # HTML шаблоны

└── requirements.txt  # Зависимости Python
```

## API Endpoints

### Аутентификация (`/api/v1/auth`)
- `POST /login` - вход в систему
- `POST /refresh` - обновление токенов
- `POST /logout` - выход из системы

### Пользователи (`/api/v1/user`)
- `POST /register` - регистрация нового пользователя
- `GET /me` - информация о текущем пользователе
- `GET /me/forms` - формы текущего пользователя

### Формы (`/api/v1/forms`)
- `GET /cells` - список валидных ячеек формы
- `POST /create` - создание новой формы
- `GET /{form_id}` - получение формы по ID
- `PUT /{form_id}` - обновление формы
- `DELETE /{form_id}` - удаление формы

### Веб-страницы
- `GET /login` - страница входа
- `GET /register` - страница регистрации
- `GET /` - главная страница с формой
- `GET /documents` - список документов пользователя
- `GET /document/edit/{form_id}` - редактирование документа

## Конфигурация

### Переменные окружения

```bash
# MongoDB
MONGO_USER=user
MONGO_PASSWORD=password
MONGO_DB=fms

# Redis
REDIS_URL=redis://redis:6379

# Логирование
LOG_LEVEL=INFO
LOG_DIR=logs
LOG_FILE=web_log

# JWT Токены
ALGORITHM=HS256
REFRESH_TOKEN_EXPIRE_MINUTES=14400        # 10 дней
SECRET_REFRESH_KEY=secret_refresh
ACCESS_TOKEN_EXPIRE_MINUTES=15
SECRET_ACCESS_KEY=secret_access

# CSRF защита
CSRF_TOKEN_EXPIRE_MINUTES=15
SECRET_CSRF_KEY=secret_csrf

# Кеширование
USER_CACHE_MINUTES=20

# CORS
ALLOWED_ORIGINS=http://localhost:8000
```

## Установка и запуск

### 1. Клонирование репозитория
```bash
git clone https://github.com/asamarka-625/MiniFMS.git
cd MiniFMS
```

### 2. Запуск приложения
```bash
docker-compose up --build -d
```

### 3. Доступ к приложению
Откройте браузер и перейдите по адресу: `http://localhost:8000`

## Безопасность

### Аутентификация
- Используется двухуровневая система токенов: access и refresh токены
- Access токены живут 15 минут, refresh токены - 10 дней

### CSRF защита
- Каждый POST/PUT/DELETE запрос требует CSRF токен
- CSRF токены генерируются при каждом запросе access токена

### Хранение паролей
- Пароли пользователей хешируются с использованием passlib
- Никогда не хранятся в открытом виде

### Защита сессий
- Refresh токены хранятся в Redis с ограничением по времени
- При каждой аутентификации создается новый refresh токен, старый удаляется

### Логирование
Приложение использует структурированное логирование в файлы:
- `logs/web_log.log` - основные логи приложения